from pptx import Presentation
from pptx.util import Inches
import matplotlib.pyplot as plt
import os
import tempfile
import shutil

def create_ppt(metrics, summary, monthly_df=None):
    prs = Presentation()
    title_slide_layout = prs.slide_layouts[0]
    bullet_slide_layout = prs.slide_layouts[1]

    slide = prs.slides.add_slide(title_slide_layout)
    slide.shapes.title.text = "Board Meeting Report"
    slide.placeholders[1].text = "Generated by AI Slide Generator"

    # Executive Summary
    slide = prs.slides.add_slide(bullet_slide_layout)
    slide.shapes.title.text = "Executive Summary"
    content = slide.placeholders[1]
    summary_lines = summary.strip().splitlines()
    content.text = summary_lines[0] if summary_lines else ""
    for line in summary_lines[1:]:
        content.text += f"\n{line.strip()}"

    # Skip charts if data isn't available (PDF case)
    if monthly_df is None or monthly_df.empty:
        prs.save("Board_Meeting_Slides.pptx")
        return "Board_Meeting_Slides.pptx"

    # Temporary image storage
    assets_dir = tempfile.mkdtemp()

    # Revenue
    rev_path = os.path.join(assets_dir, "rev.png")
    plt.figure()
    plt.plot(monthly_df['Month'], monthly_df['Revenue'], marker='o')
    plt.title("Monthly Revenue")
    plt.xlabel("Month")
    plt.ylabel("Revenue")
    plt.tight_layout()
    plt.savefig(rev_path)
    plt.close()

    slide = prs.slides.add_slide(bullet_slide_layout)
    slide.shapes.title.text = "Revenue Trend"
    slide.shapes.add_picture(rev_path, Inches(1), Inches(1.5), width=Inches(6))

    # Cost
    cost_path = os.path.join(assets_dir, "cost.png")
    plt.figure()
    plt.bar(monthly_df['Month'], monthly_df['Cost'], color='orange')
    plt.title("Monthly Costs")
    plt.xlabel("Month")
    plt.ylabel("Cost")
    plt.tight_layout()
    plt.savefig(cost_path)
    plt.close()

    slide = prs.slides.add_slide(bullet_slide_layout)
    slide.shapes.title.text = "Cost Breakdown"
    slide.shapes.add_picture(cost_path, Inches(1), Inches(1.5), width=Inches(6))

    # Churn
    churn_path = os.path.join(assets_dir, "churn.png")
    plt.figure()
    plt.plot(monthly_df['Month'], monthly_df['Churn'], marker='x', color='red')
    plt.title("Churn Rate")
    plt.xlabel("Month")
    plt.ylabel("Churn (%)")
    plt.tight_layout()
    plt.savefig(churn_path)
    plt.close()

    slide = prs.slides.add_slide(bullet_slide_layout)
    slide.shapes.title.text = "Customer Churn Rate"
    slide.shapes.add_picture(churn_path, Inches(1), Inches(1.5), width=Inches(6))

    output_path = "Board_Meeting_Slides.pptx"
    prs.save(output_path)
    shutil.rmtree(assets_dir)

    return output_path
