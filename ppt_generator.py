from pptx import Presentation
from pptx.util import Inches, Pt
from pptx.dml.color import RGBColor
import matplotlib.pyplot as plt
import os

# Apply a blue-corporate-friendly matplotlib style
plt.style.use("seaborn-v0_8-dark-palette")

def add_section_slide(prs, title):
    layout = prs.slide_layouts[5]  # Title Only
    slide = prs.slides.add_slide(layout)
    slide.shapes.title.text = title
    slide.shapes.title.text_frame.paragraphs[0].font.size = Pt(32)

def create_ppt(metrics, summary, monthly_df):
    prs = Presentation()
    title_slide_layout = prs.slide_layouts[0]

    # --- Slide 1: Title ---
    slide = prs.slides.add_slide(title_slide_layout)
    slide.shapes.title.text = "ðŸ“˜ Q2 Board Meeting Report"
    slide.placeholders[1].text = "Generated by AI Board Slide Generator"

    # Optional: Add company logo (uncomment and add logo path)
    # logo_path = "assets/logo.png"
    # if os.path.exists(logo_path):
    #     slide.shapes.add_picture(logo_path, Inches(6.5), Inches(0.2), height=Inches(1))

    # --- Slide 2: Executive Summary ---
    layout = prs.slide_layouts[5]  # Title only
    slide = prs.slides.add_slide(layout)
    slide.shapes.title.text = "Executive Summary"

    left, top, width, height = Inches(0.5), Inches(1.5), Inches(9), Inches(5)
    txBox = slide.shapes.add_textbox(left, top, width, height)
    tf = txBox.text_frame
    tf.word_wrap = True
    tf.margin_bottom = 0
    tf.margin_top = 0

    p = tf.add_paragraph()
    p.text = summary.strip()
    p.font.size = Pt(18)
    p.font.color.rgb = RGBColor(40, 40, 40)

    # Create assets folder if not exists
    os.makedirs("assets", exist_ok=True)

    # --- Slide 3: Revenue Trend ---
    add_section_slide(prs, "Revenue Analysis")
    revenue_chart_path = "assets/revenue_chart.png"
    plt.figure(figsize=(8, 4))
    plt.plot(monthly_df['Month'], monthly_df['Revenue'], marker='o', linewidth=2.5)
    plt.title("Monthly Revenue")
    plt.xlabel("Month")
    plt.ylabel("Revenue")
    plt.grid(True)
    plt.tight_layout()
    plt.savefig(revenue_chart_path)
    plt.close()
    slide = prs.slides.add_slide(prs.slide_layouts[5])
    slide.shapes.title.text = "Revenue Trend"
    slide.shapes.add_picture(revenue_chart_path, Inches(1), Inches(1.5), width=Inches(6.5))

    # --- Slide 4: Cost Breakdown ---
    add_section_slide(prs, "Cost Analysis")
    cost_chart_path = "assets/cost_chart.png"
    plt.figure(figsize=(8, 4))
    plt.bar(monthly_df['Month'], monthly_df['Cost'], color='#1f77b4')
    plt.title("Monthly Costs")
    plt.xlabel("Month")
    plt.ylabel("Cost")
    plt.grid(axis='y')
    plt.tight_layout()
    plt.savefig(cost_chart_path)
    plt.close()
    slide = prs.slides.add_slide(prs.slide_layouts[5])
    slide.shapes.title.text = "Cost Breakdown"
    slide.shapes.add_picture(cost_chart_path, Inches(1), Inches(1.5), width=Inches(6.5))

    # --- Slide 5: Churn Rate ---
    add_section_slide(prs, "Customer Retention")
    churn_chart_path = "assets/churn_chart.png"
    plt.figure(figsize=(8, 4))
    plt.plot(monthly_df['Month'], monthly_df['Churn'], marker='x', linestyle='--', color='crimson')
    plt.title("Customer Churn Rate")
    plt.xlabel("Month")
    plt.ylabel("Churn (%)")
    plt.grid(True)
    plt.tight_layout()
    plt.savefig(churn_chart_path)
    plt.close()
    slide = prs.slides.add_slide(prs.slide_layouts[5])
    slide.shapes.title.text = "Churn Trend"
    slide.shapes.add_picture(churn_chart_path, Inches(1), Inches(1.5), width=Inches(6.5))

    # Save
    output_path = "Board_Meeting_Slides.pptx"
    prs.save(output_path)
    return output_path
